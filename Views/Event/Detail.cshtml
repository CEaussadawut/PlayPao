@{
    ViewData["Title"] = "Event Detail";
    var currentUser = Context.Session.GetString("User");
    var isCreator = currentUser == Model.Creator;
}
@model Event

<div class="event-detail">
    <a href="/" class="btn-back">← Back</a>

    <h2>@Model.Title</h2>
    <p class="event-creator">Created by: @Model.Creator</p>

    <div class="event-content">
        <!-- Event Card -->
        <div class="event-card">
            <img src="@(string.IsNullOrEmpty(Model.ImagePath) ? "https://i.ytimg.com/vi/N_Fb4x-OAzE/oardefault.jpg" : Model.ImagePath)"
                alt="" style="height: 110px; width: 200px; border-radius: 8px;">
            <div class="event-info">
                <p class="event-date" style="color: #FF742B">
                    @Model.Date.ToString("dddd, MMMM d, yyyy")
                    @Model.Time.Hours.ToString("D2"):@Model.Time.Minutes.ToString("D2") -
                    @Model.EndTime.Hours.ToString("D2"):@Model.EndTime.Minutes.ToString("D2")
                </p>
                <p>@Model.Description</p>
                <p>จำนวนผู้เข้าร่วม: @Model.CurrentMembers / @Model.Member</p>
                @if (!string.IsNullOrEmpty(currentUser) && !isCreator)
                {
                    var existingRequest = ((List<EventJoinRequest>)ViewBag.JoinRequests)?.FirstOrDefault(r => r.EventId ==
                    Model.Id && r.User == currentUser);
                    var isJoined = Model.JoinedUsers.Contains(currentUser);

                    if (isJoined)
                    {
                        <p style="color: green;">You are a member of this event.</p>
                    }
                    else if (existingRequest != null && existingRequest.Status == "Pending")
                    {
                        <p style="color: orange;">Join request pending approval.</p>
                    }
                    else if (existingRequest != null && existingRequest.Status == "Rejected")
                    {
                        <p style="color: red;">Join request was rejected.</p>
                    }
                    else if (Model.CurrentMembers >= Model.Member)
                    {
                        <button type="submit" class="btn-join" disabled
                            style="background-color: gray; cursor: not-allowed;">Full</button>
                    }
                    else
                    {
                        <form method="post" action="@Url.Action("RequestJoin", "Event")" style="display: inline;">
                            <input type="hidden" name="eventId" value="@Model.Id" />
                            <button type="submit" class="btn-join">Request to Join</button>
                        </form>
                    }
                }
                @if (isCreator)
                {
                    <p style="font-style: italic; color: #666;">You created this event</p>
                    <div class="flex gap-2 mt-2">
                        <form method="post" action="@Url.Action("Edit", "Event", new { id = Model.Id })"
                            style="display: inline;" )>
                            <button type="submit" class="px-3 py-1 text-sm"
                                style="background-color: #007bff; color: white; border-radius: 2rem; border: none; cursor: pointer;">Edit</button>
                        </form>
                        <form method="post" action="@Url.Action("Delete", "Event", new { id = Model.Id })"
                            style="display: inline;"
                            onsubmit="return confirm('Are you sure you want to delete this event?')">
                            <button type="submit" class="px-3 py-1 text-sm"
                                style="background-color: #dc3545; color: white; border-radius: 2rem; border: none; cursor: pointer;">Delete</button>
                        </form>
                    </div>
                }
            </div>
        </div>

        <!-- Chat Box -->
        <div class="chat-box">
            <h4>Chat</h4>
            <div class="chat-messages">
                <!-- Chat messages would go here -->
            </div>
            <form class="chat-input">
                <input type="text" placeholder="Type..." />
                <button type="submit">➤</button>
            </form>
        </div>

        <!-- Joined Users -->
        @if (ViewBag.JoinedUserProfiles != null && ((List<UserProfile>)ViewBag.JoinedUserProfiles).Any())
        {
            <div class="joined-users">
                <h4>Joined Users</h4>
                <div class="users-grid">
                    @foreach (var profile in (List<UserProfile>)ViewBag.JoinedUserProfiles)
                    {
                        <div class="user-card">
                            <img src="@profile.AvatarUrl" alt="Avatar" class="user-avatar">
                            <div class="user-info">
                                <h5>@profile.DisplayName</h5>
                                <p>@(profile.UserName == Model.Creator ? "Creator" : "Member")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>