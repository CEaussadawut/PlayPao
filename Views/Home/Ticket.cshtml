@model IEnumerable<PlayPao.Models.Ticket>
@using System.Globalization
@using PlayPao.Controllers   @* เรียก EventController.FindEvent *@

@{
    ViewData["Title"] = "Tickets";
}

<style>
:root{ --brand:#FF742B; --muted:#6b7280; --paper:#fff; }
.tickets{display:flex;flex-direction:column;gap:24px;max-width:980px;margin:0 auto;padding:20px}
.ticket{position:relative;display:grid;grid-template-columns:120px 1fr 280px;background:var(--paper);border-radius:16px;border:2px solid #e5e7eb;box-shadow:0 8px 20px rgba(0,0,0,.12);overflow:hidden;min-height:360px}
.ticket__ribbon{position:absolute;inset:0 0 auto 0;height:80px;background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:0 24px;z-index:1}
.ticket__ribbon img{width:42px;height:42px;background:#fff;border-radius:8px;padding:4px}
.ticket__ribbon-title{font-size:32px;font-weight:900}
.ticket__barcode{margin-top:80px;background:#f9fafb;display:flex;align-items:stretch;justify-content:center;padding:12px 8px;border-right:2px dashed #e5e7eb}
.ticket__barcode-bars{width:96px;height:100%;background:repeating-linear-gradient(90deg,#111 0 3px,transparent 3px 6px);border-radius:6px}
.ticket__content{padding:100px 24px 24px;display:flex;flex-direction:column;gap:16px}
.ticket__title{font-size:clamp(24px,3vw,36px);font-weight:900;margin:0}
.ticket__desc{color:var(--muted);line-height:1.6;margin:0}
.ticket__time{margin-top:auto;padding-top:4px}
.ticket__time-label{color:var(--brand);font-weight:900}
.ticket__time-value{font-weight:900;font-size:clamp(20px,2vw,28px)}
.ticket__image-wrapper{margin-top:80px;padding:20px;background:#f9fafb}
.ticket__img{width:100%;height:240px;object-fit:cover;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.btn{display:inline-block;padding:12px 28px;border-radius:10px;text-decoration:none;border:none;font-weight:900}
.btn--primary{background:var(--brand);color:#fff}
@@media (max-width:980px){.ticket{grid-template-columns:60px 1fr}.ticket__image-wrapper{display:none}.ticket__barcode-bars{width:40px}}
@@media (max-width:640px){.ticket{grid-template-columns:1fr}.ticket__barcode{display:none}}
</style>

<div class="tickets">
  @if (Model != null && Model.Any())
  {
    foreach (var t in Model)
    {
        // ดึง Event สดจาก store
        var ev = EventController.FindEvent(t.EventId);

        var title     = ev?.Title       ?? t.EventTitle;
        var desc      = ev?.Description ?? t.Description;
        var imagePath = string.IsNullOrWhiteSpace(ev?.ImagePath) ? t.ImagePath : ev!.ImagePath;
        var date      = ev?.Date        ?? t.Date;
        var time      = ev?.Time        ?? t.Time;
        var endTime   = ev?.EndTime     ?? t.EndTime;
        var location  = ev?.Location    ?? t.Location;

      <article class="ticket">
        <div class="ticket__ribbon">
          <img src="~/images/icon.png" alt="logo" />
          <div class="ticket__ribbon-title">TICKET</div>
        </div>

        <div class="ticket__barcode" aria-hidden="true">
          <div class="ticket__barcode-bars"></div>
        </div>

        <section class="ticket__content">
          <h2 class="ticket__title">@title</h2>
          @if (!string.IsNullOrWhiteSpace(desc))
          { <p class="ticket__desc">@desc</p> }

          <div class="ticket__time">
            <div class="ticket__time-label">Appointed Time</div>
            <div class="ticket__time-value">
              @date.ToString("d/M/yyyy", CultureInfo.InvariantCulture)
              @time.Hours.ToString("D2"):@time.Minutes.ToString("D2")
              -
              @endTime.Hours.ToString("D2"):@endTime.Minutes.ToString("D2")
              @if (!string.IsNullOrWhiteSpace(location))
              { <span style="color:#6b7280"> • @location</span> }
            </div>
          </div>

          <div style="margin-top:12px">
            <a asp-controller="Event" asp-action="Detail" asp-route-id="@t.EventId" class="btn btn--primary">View Event</a>
          </div>
        </section>

        <aside class="ticket__image-wrapper">
          <img class="ticket__img"
               src="@(string.IsNullOrWhiteSpace(imagePath) ? "https://i.ytimg.com/vi/N_Fb4x-OAzE/oardefault.jpg" : imagePath)"
               alt="@title" />
        </aside>
      </article>
    }
  }
  else
  {
    <p style="text-align:center; color:var(--muted); padding:40px;">
      No tickets yet. Join an event to see your tickets here.
    </p>
  }
</div>
