@{
    ViewData["Title"] = "Home Page";
    var currentUser = Context.Session.GetString("User");
    var bookmarks = PlayPao.Controllers.HomeController.BookmarksByUser.TryGetValue(currentUser ?? "", out var b) ? b : new
    List<int>();
}
@using System.Globalization
@using System.Collections.Generic
@model IEnumerable<Event>

<style>
    .badge-full {
        background: #f3f4f6;
        color: #374151;
        border-radius: 12px;
        padding: 2px 10px;
        font-size: 12px;
        font-weight: 700;
    }

    .btn-join {
        background: #FF742B;
        color: #fff;
        border: none;
        border-radius: 999px;
        padding: .4rem .9rem;
        cursor: pointer;
    }

    .btn-join.disabled {
        background: #e5e7eb;
        color: #6b7280;
        cursor: not-allowed;
    }
</style>

<div class="flex flex-col gap-1 text-center">
    <div class="flex items-center gap-1">
        <form method="get" asp-controller="Home" asp-action="Index" class="search-form">
            <input class="input-theme-full" type="text" name="search" placeholder="Search events..."
                value="@ViewBag.Search">
            <button type="submit"
                style="padding:0.5rem 1rem; background:#FF742B; color:#fff; border:none; border-radius:4px; cursor:pointer;">Search</button>
        </form>
        @if (!string.IsNullOrWhiteSpace(currentUser))
        {
            <div class="top-bar" style="margin-top: 0.75rem;">
                <div class="notification-area">
                    <a href="#" class="notification-icon" onclick="toggleNotificationBox()">
                        <i data-lucide="bell"></i>
                        <span class="badge" id="notification-badge" style="display: none;">0</span>
                    </a>

                    <div class="notification-box hidden" id="notification-box">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button onclick="toggleNotificationBox()">×</button>
                        </div>
                        <div class="notification-list" id="notification-list">
                        </div>
                        <div class="notification-footer">
                            <a asp-controller="Notification" asp-action="Index">View All</a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (Model != null && Model.Any())
    {
        foreach (var eventItem in Model)
        {
            var isFull = eventItem.CurrentMembers >= eventItem.Member;

            <div onclick="location.href='@Url.Action("Detail", "Event", new { id = eventItem.Id })'"
                style="display:flex; box-shadow:0 0 5px rgb(0 0 0 / 0.2); padding:1rem; border-radius:0.5rem; cursor:pointer;">
                <img src="@(string.IsNullOrEmpty(eventItem.ImagePath) ? "https://i.ytimg.com/vi/N_Fb4x-OAzE/oardefault.jpg" : eventItem.ImagePath)"
                    alt="" style="height:110px; width:200px; border-radius:8px;">
                <div
                    style="padding-top:8px; padding-bottom:8px; padding-right:14px; padding-left:14px; gap:8px; width:100%; margin-right:8px">
                    <h5 style="color:#FF742B">
                        @eventItem.Date.ToString("dddd, MMMM d, yyyy")
                        @eventItem.Time.Hours.ToString("D2"):@eventItem.Time.Minutes.ToString("D2")
                        -
                        @eventItem.EndTime.Hours.ToString("D2"):@eventItem.EndTime.Minutes.ToString("D2")
                    </h5>
                    <h3>@eventItem.Title</h3>
                    <p>@eventItem.Description</p>
                    <p style="font-size:.8em; color:#666;">Created by: @eventItem.Creator</p>
                </div>

                <div class="flex flex-col justify-between items-end" style="gap:.5rem;">
                    @if (isFull)
                    {
                        <span class="badge-full">Full</span>
                    }
                    else
                    {
                        var isBookmarked = bookmarks.Contains(eventItem.Id);
                        <form method="post" asp-controller="Home" asp-action="ToggleBookmark" asp-route-eventId="@eventItem.Id"
                            onclick="event.stopPropagation();" style="background:none; border:none; padding:0; margin:0;">
                            @Html.AntiForgeryToken()
                            <button type="submit" style="background:none; border:none; cursor:pointer; padding:0;">
                                <i data-lucide="bookmark" style="color: @(isBookmarked ? "#FF742B" : "#6b7280")"></i>
                            </button>
                        </form>
                    }

                    <p style="width:126px; text-align:right; margin:0;">
                        @eventItem.CurrentMembers / @eventItem.Member
                    </p>

                    <div class="flex gap-2">
                        @if (!string.IsNullOrEmpty(currentUser) && currentUser != eventItem.Creator)
                        {
                            var existingRequest = ((List<EventJoinRequest>)ViewBag.JoinRequests)?.FirstOrDefault(r => r.EventId ==
                            eventItem.Id && r.User == currentUser);
                            var isJoined = eventItem.JoinedUsers.Contains(currentUser);

                            if (isJoined)
                            {
                                <span style="font-style:italic; color:#666; width:126px; text-align:right;">
                                    Joined
                                </span>
                            }
                            else if (existingRequest != null && existingRequest.Status == "Pending")
                            {
                                <span style="font-style:italic; color:#666; width:126px; text-align:right;">
                                    Request Pending
                                </span>
                            }
                            else if (existingRequest != null && existingRequest.Status == "Rejected")
                            {
                                <span style="font-style:italic; color:#666; width:126px; text-align:right;">
                                    Request Rejected
                                </span>
                            }
                            else if (isFull)
                            {
                                <button class="btn-join disabled" disabled onclick="event.stopPropagation();">Full</button>
                            }
                            else
                            {
                                <form method="post" asp-controller="Event" asp-action="RequestJoin" asp-route-eventId="@eventItem.Id"
                                    onclick="event.stopPropagation();">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn-join">Request to Join</button>
                                </form>
                            }
                        }
                        else if (currentUser == eventItem.Creator)
                        {
                            <span style="font-style:italic; color:#666; width:126px; text-align:right;">
                                Created by you
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <p>No events available.</p>
    }
</div>